# システム設計

システムとしての方向性とそれを満たすシステムの構成について検討・設計内容を記録する。

## コンセプト

### メインコンセプト

**自由曲線で**高速に走行する

### チャレンジしたいこと

- スカートなし吸引
- 昇降圧レギュレータによる走行電力管理
- 光センサを利用した PC との光 UART 通信
- 自己発光式ストロボスコープによる調整

## 要求

### 走行性能

2023 年度大会の上位陣のパラメータを参考に、走行性能の目標性能を以下のように設定する。

| 項目             | 値          |
| ---------------- | ----------- |
| 加速度           | 35[m/s^2]   |
| 最高速度         | 7[m/s]      |
| ターン向心加速度 | 60[m/s^2]   |
| 角加速度         | 15000[rad/s^2] |

### 機能

コンセプトを実現するための機能の一覧を以下に示す。

- マイクロマウス競技機能
  - NTF が定めるマイクロマウス競技に則った走行を行う
  - 探索走行
    - 最速経路を短い時間で探索する事を目的として走行する
  - 最短走行
    - 最速経路を走行する
- 調整機能
  - 車両のパラメータを調整するための動作を再生する
- パラメータ機能
  - パラメータを保持する
  - パラメータを GUI ソフトウェアから変更する
- ログ機能
  - 走行ログ機能
    - 走行時のタイムスタンプ・生センサ値・車両の状態空間を毎制御周期記録する
  - イベントログ機能
    - 特定のイベントが発生した事を 1uS 分解能のタイムスタンプとイベント種別で記録する
  - 天井カメラログ
    - 車両 LED のストロボ発光と天井カメラの長時間露光により位置・角度を算出する
  - ログ解析機能
    - 走行ログ・イベントログを MCU から GUI ソフトウェアに転送する
    - 走行ログと天井カメラログを組み合わせて解析を行う
- 制御機能
  - 目標軌道生成機能
    - 自由曲線で目標軌道を生成する
  - 自己位置推定機能
    - 自己位置を推定する
- デバッグ機能
  - 気持ち良いプログラムデバッグ環境を提供する
- フェイルセーフ機能
  - バッテリ電圧の下限によって機能を停止する
  - 走行失敗時に車両へのダメージを最低化させつつ停止する

## システム構成

### 開発システムの構成

気持ち良いデバッグ環境を提供するための開発システム構成を以下に示す。

![開発システム構成](assets/img/system_develop.png)

図中の各要素を以下に示す。

■ ハードウェア

| 項目                     | 説明                                                                                                                                           |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| PC                       | Ubuntu 24.04(予)をインストールしたノート PC(現在は 23.10)                                                                                      |
| Raspberry Pi + GS Camera | Rapberry Pi 4B 8GB + RPi Global Shutter Camera                                                                                                 |
| 充電器                   | さくらねずみ玄 2 のバッテリを充電する充電器です。 1S LiPo セルを 4 個同時に充電可能とする                                                      |
| 開発 I/F                 | CMSIS-DAP+VCOM または DAP-Link 相当の機能を持つデバッグアダプタ。[hs-probe](https://github.com/probe-rs/hs-probe) をベースにしたものを使用する |
| さくらねずみ玄 2         | 開発対象のマイクロマウスの機体。                                                                                                               |

■ 機能

| 項目                     | 説明                                                                                                                                           |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| Sakuranezumi ExCam       | 天井カメラをキャプチャし、LED ストロボ発光輝点のリストを抽出するソフトウェア。                                                                 |
| vscode                   | 開発環境。                                                                                                                                     |
| Sakuranezumi App         | GUI ソフトウェア。パラメータ書き込み、ログの解析を行う。                                                                                       |
| probe-rs                 | デバッガ。Debug Adapter Protocol を実装しているため vscode から MCU のデバッグが可能。                                                         |
| VirtualCOM               | 車体との UART 通信を USB と接続する。                                                                                                          |
| CMSIS-DAP v2             | ARMマイコン向けデバッグアダプタ。                                                                                                                 |

### 車両の構成

車両の主要な構成要素を以下に示す。

![車両の構成図](assets/img/system_vehicle.png)

### ソフトウェアの構成

ソフトウェアの構成図を以下に示す。

![ソフトウェアの構成図](assets/img/system_software.png)
